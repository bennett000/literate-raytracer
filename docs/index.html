<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="custom.css" />
  <link rel="shortcut icon" href="https://literate-raytracer.michaeljbennett.info/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="https://literate-raytracer.michaeljbennett.info/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://literate-raytracer.michaeljbennett.info/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="https://literate-raytracer.michaeljbennett.info/favicon-48x48.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#fff">
  <meta name="application-name" content="literate-raytracer">
  <link rel="apple-touch-icon" sizes="57x57" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-167x167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-180x180.png">
  <link rel="apple-touch-icon" sizes="1024x1024" href="https://literate-raytracer.michaeljbennett.info/apple-touch-icon-1024x1024.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="literate-raytracer">
  <link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"    href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-640x1136.png">
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"    href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-750x1334.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"    href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-828x1792.png">
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"    href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1125x2436.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"    href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1242x2208.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"    href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1242x2688.png">
  <link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1536x2048.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1668x2224.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1668x2388.png">
  <link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"  href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2048x2732.png">
  <link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"  href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1620x2160.png">
  <link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1136x640.png">
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1334x750.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-1792x828.png">
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2436x1125.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2208x1242.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"   href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2688x1242.png">
  <link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"  href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2048x1536.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"  href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2224x1668.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"  href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2388x1668.png">
  <link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2732x2048.png">
  <link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"  href="https://literate-raytracer.michaeljbennett.info/apple-touch-startup-image-2160x1620.png">
  <link rel="icon" type="image/png" sizes="228x228" href="https://literate-raytracer.michaeljbennett.info/coast-228x228.png">
  <meta name="msapplication-TileColor" content="#fff">
  <meta name="msapplication-TileImage" content="https://literate-raytracer.michaeljbennett.info/mstile-144x144.png">
  <meta name="msapplication-config" content="https://literate-raytracer.michaeljbennett.info/browserconfig.xml">
</head>
<body>
  <div id="container">
    <div class="cred">
        <a href="https://github.com/tmcw/literate-raytracer">based on an open source project by tom macwright</a>,
        <a href="https://github.com/bennett000/literate-raytracer">extended by michael bennett</a>
    </div>
    <center><canvas id="c"></canvas></center>
    <center id="l"></center>
    <center id="i"></center>
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="accelerators.html">
                accelerators.js
              </a>
            
              
              <a class="source" href="cube.html">
                cube.js
              </a>
            
              
              <a class="source" href="gl.html">
                gl.js
              </a>
            
              
              <a class="source" href="html.html">
                html.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="log.html">
                log.js
              </a>
            
              
              <a class="source" href="matrix.html">
                matrix.js
              </a>
            
              
              <a class="source" href="scene.html">
                scene.js
              </a>
            
              
              <a class="source" href="shader-configuration.html">
                shader-configuration.js
              </a>
            
              
              <a class="source" href="shaders.html">
                shaders.js
              </a>
            
              
              <a class="source" href="utility.html">
                utility.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Welcome to the Literate Ray Tracer, a program that reads like a book.
This book is a long winded fork of <a href="https://github.com/tmcw/literate-raytracer" title="tom macwright&#39;s literate ray tracer">Tom Macwright’s</a>
In addition to Tom’s work, the following websights were leveraged extensively</p>
<ul>
<li><a href="https://webglfundamentals.org/" title="WebGL Fundamentals, a great source for learning WebGL from scratch">WebGL Fundamentals</a>, for learning to grok WebGL</li>
<li><a href="https://learnopengl.com/" title="Learn OpenGL, a great source for traditional and PBR approaches to lighting and 3D">Learn OpenGL</a>, for getting a better handle on lighting</li>
<li><a href="https://www.scratchapixel.com/" title="Scratchapixel has loads of details on the maths behind raytracing and rasterization as well as loads of source code">Scratchapixel</a>, for ray tracing and more</li>
</ul>
<h2 id="how-to-read-this-book">How To Read This Book</h2>
<p>With any luck this book reads like any other “book” on the web in 2020
with the literate programming twist that there’s real running code snippets
inbetween prose.</p>
<p>The code is all real and is <a href="https://github.com/bennett000/literate-raytracer" title="Literate Ray Tracer">written in TypeScript</a>
and runs in a slightly “simpler” way than most web apps in 2020.</p>
<p>To keep it simple,</p>
<ol>
<li>The code is all here, no libraries required</li>
<li>The code all executes in the global browser space, no official “modules”</li>
<li>Performance is <em>not</em> prioritized, it’s not ignored entirely but the focus is on simplicity</li>
</ol>
<p>Please <a href="https://github.com/bennett000/literate-raytracer/issues" title="Report an issue with the book">report and defects here</a> and we’ll attempt to address the issue in the next release</p>
<h2 id="30000-foot-view">30,000 Foot View</h2>
<p>We’re going to be working in a prety “weird” way for most JS devs, and many other devs.
Web developers are already used to jumping from HTML to JS to CSS and back.  On top of
that we’re going to be jumping into <a href="https://www.khronos.org/opengl/wiki/Core_Language_(GLSL)" title="GL Shader Language">GLSL</a>
specifically an older version that is used on embedded devices and the web.  It’s somewhat
like a simplified C with a dash of C++</p>
<h3 id="tech-overview">Tech Overview</h3>
<ul>
<li>HTML + CSS show the 3D graphics output in a canvas</li>
<li>JavaScript controls the HTML and orchestrates the GLSL program(s)</li>
<li>GLSL compiles and runs on the GPU (video card)</li>
</ul>
<h3 id="ray-tracer-overview">Ray Tracer Overview</h3>
<p>We’ll assume the audience knows what a ray tracer is, if not, checkout the links
at the top and wikipedia.</p>
<p>This particular ray tracer is built to show people a bunch of fun graphics things that
can be done in a relatively cross compatible way in the browser.  We’re using WebGL
1.x to keep it as compatable as possible. </p>
<p>The high level algorithm is:</p>
<ol>
<li>For each frame JavaScript will update a 3D universe and inform the GPU</li>
<li>For each <em>pixel</em> in each frame the GPU will cast out a ray and see if it hits an object.<ol>
<li>If <em>no</em> object is hit, render a background colour</li>
<li>If an object is hit, check if it can see any lights, if so draw a colour, if not, a shadow</li>
</ol>
</li>
</ol>
<p>Beyond that we’ll also look at casting more rays to do things like reflections, and refractions</p>
<h2 id="contents">Contents</h2>
<ol start="0">
<li><a href="#configuration">Configuration</a></li>
<li><a href="#html">HTML <em>and more!</em></a></li>
<li><a href="#state">Application State</a></li>
<li><a href="#animation">Animation!</a></li>
</ol>
<p><a name="configuration"></a></p>
<h2 id="0-configuration">0. Configuration</h2>
<p>configuration is an important part of our application.  before we even go there we
will want a place to provide the user and/or developer feedback.  Let’s make a logger
and we’ll assume all logs are user facing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> g_logger = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> logEl = getHtmlLog();
    <span class="hljs-keyword">return</span> logEl ? createHtmlLogReplacement(logEl) : createConsoleLog();
}());
g_logger.log(<span class="hljs-string">'hello world'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><code>g_floorPlaneSize</code> is an arbitrary boundary to our scene and describes
sizing used to bound animations and define a “floor plane” on which we
can see shadows</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> g_floorPlaneSize = <span class="hljs-number">25</span>;
<span class="hljs-keyword">const</span> g_scene = getScene();
<span class="hljs-keyword">const</span> g_configShader = getShaderConfiguration(g_scene);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><a name="html"></a></p>
<h2 id="1-html-and-more">1. HTML <em>and more!</em></h2>
<p>We’ll <a href="html.html" title="HTML Setup code">setup the HTML</a>
and while we’re at it we should note that from here we start down the road to
working with the GPU.  Part of getting the canvas is gonig to be listening for
“lost context”.  The GPU is a shared resource and sometimes some of the programs
using the GPU do not function as expected and the operating system asks the GPU
to reset itself</p>
<p>Let’s make sure it’s easy (and fast) to repeat all the things we need to do to start
the WebGL process</p>
<p>before we start the setup, we’ll need a place we can all find the <code>WebGLRenderingContext</code>,
essentially the API to the GPU. This seems like a silly thing to worry about <em>but</em> the <code>gl</code> 
context can be <a href="https://www.khronos.org/webgl/wiki/HandlingContextLost" title="How to handle a lost rendering context">“lost” at any time</a></p>
<p>let’s create a simple state object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> g_glState = {
    <span class="hljs-attr">ctx</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">gl</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">uniforms</span>: <span class="hljs-literal">null</span>,
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>let’s make our GL setup code easy to repeat
we’ll do so with a little dependency injection via  higher order function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> createStartWebGl = <span class="hljs-function">(<span class="hljs-params">logger</span>) =&gt;</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    logger.log(<span class="hljs-string">'Starting WebGL'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>In order to upload things to the GPU and renderthem on the canvas we’ll need to work
with an API.  We can ask our canvas for a <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext" title="WebGL Rendering Context is the API we use to upload stuff to the GPU">WebGLRenderingContext</a>;
which will be the API we use to upload stuff to the GPU.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    g_glState.gl = g_canvas.getContext(<span class="hljs-string">'webgl'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>if gl is falsey we won’t handle it here, that’s what the lostContext handler is for
however we also don’t need to waste time/resources proceeding, so let’s bail</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!g_glState.gl) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>there’s one case where we’ll want to know </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    logger.log(<span class="hljs-string">'Got context!'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Okay, great, so we’ve got a an API that let’s us talk to the GPU.  Alone that’s
not enough for us to get started.  We need to give the GPU some code to run
we’re going to need at least one GLSL program, that code is <a href="shaders.html" title="Our shaders, the &#39;body&#39; of our program">located in shaders.ts</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    g_glState.ctx = bindProgram(g_glState.gl, getVertexSource(), getFragmentSource(g_configShader), logger);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>if something failed during compilatioin we should bail</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!g_glState.ctx) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    logger.log(<span class="hljs-string">'Setup scene and bind uniforms'</span>);
    g_glState.uniforms = setupScene(g_glState.gl, g_glState.ctx, g_scene, g_configShader);
    logger.log(<span class="hljs-string">'Drawing'</span>);
    draw(g_glState.gl, g_glState.ctx, g_canvas);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>let’s make sure things worked as expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> error = g_glState.gl.getError();
    <span class="hljs-keyword">if</span> (error !== g_glState.gl.NO_ERROR &amp;&amp; error !== g_glState.gl.CONTEXT_LOST_WEBGL) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>let’s create a function we can use to either kick off or restart WebGL</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> startWebGl = createStartWebGl(g_logger);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>start webgl and loadup the global logger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> g_canvas = getHtmlCanvas(g_logger, startWebGl);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>if we cannot start WebGL the first time, we have a serious problem</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> didStart = tryCatch(startWebGl, (result) =&gt; {
    <span class="hljs-keyword">if</span> (result) {
        g_logger.log(<span class="hljs-string">'Started WebGl'</span>);
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> error = <span class="hljs-string">'Could not initialize WebGL on this device'</span>;
        g_logger.error(error);
        throwIfFalsey(<span class="hljs-literal">false</span>, error);
    }
}, (e) =&gt; {
    throwIfFalsey(<span class="hljs-literal">false</span>, <span class="hljs-string">'WebGL failed to start '</span> + e.message);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><a name="state"></a></p>
<h2 id="3-application-state">3. Application State</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> g_planetStates = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> states = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; g_scene.spheres.length; i += <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">const</span> p = g_scene.spheres[i].point;
        <span class="hljs-keyword">const</span> x = (<span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span>);
        <span class="hljs-keyword">const</span> y = (<span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span>);
        <span class="hljs-keyword">const</span> z = (<span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span>);
        states.push({
            <span class="hljs-attr">matrix</span>: translate4_4(identity4_4(), p[<span class="hljs-number">0</span>], p[<span class="hljs-number">1</span>], p[<span class="hljs-number">2</span>]),
            <span class="hljs-attr">vector</span>: normalize3_1([x, y, z]),
        });
    }
    <span class="hljs-keyword">return</span> states;
}());
<span class="hljs-keyword">const</span> g_fps = {
    <span class="hljs-attr">countTime</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">lastTime</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">frames</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">sampleDuration</span>: <span class="hljs-number">5000</span>,
};
<span class="hljs-keyword">const</span> g_userControllableState = {
    <span class="hljs-attr">shadingModel</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">aa</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">isAnimating</span>: <span class="hljs-literal">true</span>,
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><a name="animate"></a>
4. ## Animate!</p>
<p>start the animation by default
on each frame…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> animate = <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { aa, isAnimating, shadingModel } = g_userControllableState;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if we’re not animating bail, the consumer will need to restart</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (isAnimating === <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>if we somehow lost GL context skip to the next frame, this is not intentional
and we should restart for the consumer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!g_glState.ctx || !g_glState.gl || !g_glState.uniforms) {
        requestAnimationFrame(animate);
        <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>update our FPS state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    g_fps.frames += <span class="hljs-number">1</span>;
    g_fps.countTime += time - g_fps.lastTime;
    g_fps.lastTime = time;
    <span class="hljs-keyword">if</span> (g_fps.countTime &gt;= g_fps.sampleDuration) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'fps'</span>, g_fps.frames / (g_fps.countTime / <span class="hljs-number">1000</span>));
        g_fps.frames = <span class="hljs-number">0</span>;
        g_fps.countTime = <span class="hljs-number">0</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>update the state of our spheres</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    g_planetStates.forEach(<span class="hljs-function">(<span class="hljs-params">state, i</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (state.matrix[<span class="hljs-number">12</span>] &gt; g_floorPlaneSize) {
                state.vector = normalize3_1([<span class="hljs-number">-1</span>, state.vector[<span class="hljs-number">1</span>], state.vector[<span class="hljs-number">2</span>]]);
            }
            <span class="hljs-keyword">if</span> (state.matrix[<span class="hljs-number">13</span>] &gt; <span class="hljs-number">15</span>) {
                state.vector = normalize3_1([state.vector[<span class="hljs-number">0</span>], <span class="hljs-number">-1</span>, state.vector[<span class="hljs-number">2</span>]]);
            }
            <span class="hljs-keyword">if</span> (state.matrix[<span class="hljs-number">14</span>] &gt; g_floorPlaneSize) {
                state.vector = normalize3_1([state.vector[<span class="hljs-number">0</span>], state.vector[<span class="hljs-number">1</span>], <span class="hljs-number">-1</span>]);
            }
            <span class="hljs-keyword">if</span> (state.matrix[<span class="hljs-number">12</span>] &lt; -g_floorPlaneSize) {
                state.vector = normalize3_1([<span class="hljs-number">1</span>, state.vector[<span class="hljs-number">1</span>], state.vector[<span class="hljs-number">2</span>]]);
            }
            <span class="hljs-keyword">if</span> (state.matrix[<span class="hljs-number">13</span>] &lt; <span class="hljs-number">0.5</span>) {
                state.vector = normalize3_1([state.vector[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, state.vector[<span class="hljs-number">2</span>]]);
            }
            <span class="hljs-keyword">if</span> (state.matrix[<span class="hljs-number">14</span>] &lt; -g_floorPlaneSize) {
                state.vector = normalize3_1([state.vector[<span class="hljs-number">0</span>], state.vector[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>]);
            }
            <span class="hljs-keyword">const</span> speed = <span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">3</span> + <span class="hljs-number">5</span>;
            <span class="hljs-keyword">const</span> x = state.vector[<span class="hljs-number">0</span>] / speed;
            <span class="hljs-keyword">const</span> y = state.vector[<span class="hljs-number">1</span>] / speed;
            <span class="hljs-keyword">const</span> z = state.vector[<span class="hljs-number">2</span>] / speed;
            state.matrix = translate4_4(state.matrix, x, y, z);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>pin the second light to the second sphere</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (i === <span class="hljs-number">1</span>) {
                g_scene.lights[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = state.matrix[<span class="hljs-number">12</span>];
                g_scene.lights[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = state.matrix[<span class="hljs-number">13</span>];
                g_scene.lights[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>] = state.matrix[<span class="hljs-number">14</span>];
                g_glState.uniforms.pointLights[<span class="hljs-number">1</span>].point(g_scene.lights[<span class="hljs-number">1</span>]);
            }
        }
        <span class="hljs-keyword">const</span> sphere = g_scene.spheres[i];
        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {
            sphere.point = [state.matrix[<span class="hljs-number">12</span>], state.matrix[<span class="hljs-number">13</span>], state.matrix[<span class="hljs-number">14</span>]];
            g_planetStates[i] = state;
        }
        g_glState.uniforms.spheres[i].point(sphere.point);
    });
    g_glState.uniforms.shadingModel(shadingModel);
    g_glState.uniforms.aa(aa);
    draw(g_glState.gl, g_glState.ctx, g_canvas);
    requestAnimationFrame(animate);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>bind some controls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>bindInputControls(g_userControllableState);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>finally kick it all off</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>animate(<span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
  <script type="text/javascript" src="https://literate-raytracer.michaeljbennett.info/index.js"></script>
</body>
</html>
